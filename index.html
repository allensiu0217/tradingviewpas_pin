<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PineQuant Pro | 量化策略終端</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lightweight Charts (鎖定版本 v4.1.1 以支援 addCandlestickSeries) -->
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', system-ui, sans-serif; }
        .editor-area { font-family: 'Fira Code', monospace; tab-size: 2; }
        /* Scrollbar customization */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151f32', 900: '#0f172a', 950: '#020617' },
                        trade: { up: '#22c55e', down: '#ef4444' }
                    }
                }
            }
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;
        const { createChart } = LightweightCharts;

        // --- 1. 模擬數據生成 (Mock Data Generator) ---
        // 使用幾何布朗運動模擬美股數據
        const generateData = (symbol, days = 365) => {
            let data = [];
            let price = 150; // 起始價
            const date = new Date();
            date.setDate(date.getDate() - days);

            for (let i = 0; i < days; i++) {
                const vol = 0.02; // 波動率
                const change = 1 + (Math.random() * vol * 2 - vol);
                const open = price;
                const close = price * change;
                const high = Math.max(open, close) * (1 + Math.random() * 0.01);
                const low = Math.min(open, close) * (1 - Math.random() * 0.01);
                const volume = Math.floor(Math.random() * 1000000) + 500000;

                data.push({
                    time: date.toISOString().split('T')[0],
                    open: parseFloat(open.toFixed(2)),
                    high: parseFloat(high.toFixed(2)),
                    low: parseFloat(low.toFixed(2)),
                    close: parseFloat(close.toFixed(2)),
                    volume: volume
                });

                price = close;
                date.setDate(date.getDate() + 1);
            }
            return data;
        };

        // --- 2. 核心邏輯：Pine Script 轉譯器 (簡易版 AST 概念) ---
        // 這是一個簡化的轉譯器，模擬 AST 解析與 JS 生成過程
        class PineTranspiler {
            constructor(script) {
                this.script = script;
                this.indicators = [];
            }

            // 模擬靜態分析與轉換
            transpile() {
                const lines = this.script.split('\n');
                let jsCode = `
                    const results = { signals: [], indicators: {} };
                    const close = data.map(d => d.close);
                    const high = data.map(d => d.high);
                    const low = data.map(d => d.low);
                    let position = 0; // 0: flat, 1: long, -1: short
                    
                    // 內置 TA 函數模擬
                    const ta = {
                        sma: (source, length) => {
                            let output = [];
                            for(let i=0; i<source.length; i++) {
                                if(i < length - 1) { output.push(NaN); continue; }
                                let sum = 0;
                                for(let j=0; j<length; j++) sum += source[i-j];
                                output.push(sum / length);
                            }
                            return output;
                        },
                        crossover: (src1, src2, idx) => {
                            if (idx === 0) return false;
                            return (src1[idx-1] < src2[idx-1] && src1[idx] > src2[idx]);
                        },
                        crossunder: (src1, src2, idx) => {
                             if (idx === 0) return false;
                            return (src1[idx-1] > src2[idx-1] && src1[idx] < src2[idx]);
                        }
                    };
                `;

                // 解析變量定義與策略邏輯 (Regex 模擬 AST 節點提取)
                // 支援語法：sma, plot, strategy.entry
                lines.forEach(line => {
                    line = line.trim();
                    if (line.startsWith('//') || line === '') return;

                    // 解析變量賦值: ma1 = ta.sma(close, 14)
                    if (line.includes('=') && !line.startsWith('strategy')) {
                        const [varName, expr] = line.split('=').map(s => s.trim());
                        // 簡單轉換 ta.sma(close, 14) -> const ma1 = ta.sma(close, 14);
                        jsCode += `const ${varName} = ${expr};\n`;
                        jsCode += `results.indicators['${varName}'] = ${varName};\n`;
                    }

                    // 解析繪圖: plot(ma1, ...)
                    if (line.startsWith('plot')) {
                        const match = line.match(/\(([^,]+)/);
                        if (match) {
                           // 這裡僅做標記，實際數據已在上方收集
                        }
                    }
                });

                // 構建主循環執行交易邏輯
                jsCode += `
                    for(let i = 50; i < data.length; i++) {
                        // 注入用戶定義的條件邏輯 (非常簡化的替換)
                        ${this.extractStrategyLogic(lines)}
                    }
                    return results;
                `;
                
                return jsCode;
            }

            extractStrategyLogic(lines) {
                let logic = '';
                lines.forEach(line => {
                    // 將 Pine 的 if (condition) 轉換為 JS
                    if (line.includes('strategy.entry')) {
                        // 範例: if (longCondition) strategy.entry("Long", strategy.long)
                        // 簡單的正則替換來模擬
                        if (line.includes('strategy.long')) {
                             const cond = line.split('if')[1].split('strategy')[0].trim().replace(/[()]/g, '');
                             logic += `
                                if (${cond} && position !== 1) {
                                    results.signals.push({ index: i, type: 'buy', price: close[i], time: data[i].time });
                                    position = 1;
                                }
                             `;
                        } else if (line.includes('strategy.short')) {
                             const cond = line.split('if')[1].split('strategy')[0].trim().replace(/[()]/g, '');
                             logic += `
                                if (${cond} && position !== -1) {
                                    results.signals.push({ index: i, type: 'sell', price: close[i], time: data[i].time });
                                    position = -1;
                                }
                             `;
                        }
                    }
                });
                return logic;
            }
        }

        // --- 3. 性能指標計算 ---
        const calculateMetrics = (signals, initialCapital = 100000) => {
            let balance = initialCapital;
            let holdings = 0;
            let trades = [];
            let peak = initialCapital;
            let maxDrawdown = 0;

            signals.forEach((sig, idx) => {
                const nextSig = signals[idx+1];
                if (sig.type === 'buy') {
                    const shares = Math.floor(balance / sig.price);
                    holdings = shares;
                    balance -= shares * sig.price;
                    // 簡化：假設下一個信號是賣出，或者是最後一筆
                    if (!nextSig) {
                         // 持倉到最後
                    }
                } else if (sig.type === 'sell' && holdings > 0) {
                    balance += holdings * sig.price;
                    const profit = (holdings * sig.price) - (holdings * signals[idx-1].price);
                    trades.push(profit);
                    holdings = 0;
                }
                
                // DD 計算
                const currentEquity = balance + (holdings * sig.price);
                if (currentEquity > peak) peak = currentEquity;
                const dd = (peak - currentEquity) / peak;
                if (dd > maxDrawdown) maxDrawdown = dd;
            });

            // 夏普比率簡化計算
            const returns = trades.map(t => t/initialCapital);
            const avgReturn = returns.reduce((a,b)=>a+b, 0) / (returns.length || 1);
            const stdDev = Math.sqrt(returns.map(x => Math.pow(x - avgReturn, 2)).reduce((a,b) => a+b, 0) / (returns.length || 1));
            const sharpe = stdDev === 0 ? 0 : (avgReturn / stdDev) * Math.sqrt(252); // 年化

            return {
                netProfit: (balance + (holdings * (signals[signals.length-1]?.price || 0)) - initialCapital).toFixed(2),
                tradeCount: trades.length,
                sharpe: sharpe.toFixed(2),
                maxDD: (maxDrawdown * 100).toFixed(2) + '%'
            };
        };


        // --- UI Components ---

        const Header = () => (
            <div className="h-14 border-b border-slate-700 bg-slate-900 flex items-center px-4 justify-between">
                <div className="flex items-center gap-2">
                    <i data-lucide="activity" className="text-emerald-500 w-6 h-6"></i>
                    <span className="font-bold text-lg tracking-wide text-white">PineQuant <span className="text-emerald-500">Pro</span></span>
                </div>
                <div className="flex gap-4 text-sm font-medium text-slate-400">
                    <span className="hover:text-white cursor-pointer transition-colors">策略實驗室</span>
                    <span className="hover:text-white cursor-pointer transition-colors">數據中心</span>
                    <span className="hover:text-white cursor-pointer transition-colors">風險監控</span>
                    <div className="flex items-center gap-2 text-emerald-400">
                        <span className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                        API 連接正常
                    </div>
                </div>
            </div>
        );

        const StatCard = ({ label, value, sub, isPositive }) => (
            <div className="bg-slate-850 p-3 rounded border border-slate-700">
                <div className="text-xs text-slate-400 uppercase tracking-wider mb-1">{label}</div>
                <div className={`text-xl font-bold font-mono ${isPositive === true ? 'text-emerald-400' : isPositive === false ? 'text-rose-400' : 'text-white'}`}>
                    {value}
                </div>
                {sub && <div className="text-xs text-slate-500 mt-1">{sub}</div>}
            </div>
        );

        const App = () => {
            const [activeSymbol, setActiveSymbol] = useState('AAPL');
            const [marketData, setMarketData] = useState([]);
            const [backtestStats, setBacktestStats] = useState(null);
            const [logs, setLogs] = useState(["系統初始化完成...", "數據流連接: 模擬美股"]);
            const chartContainerRef = useRef(null);
            const chartInstance = useRef(null);
            const candlestickSeries = useRef(null);
            const indicatorSeries = useRef({});
            const markers = useRef([]);

            // 預設 Pine Script 策略
            const [pineCode, setPineCode] = useState(
`// 雙均線交叉策略
// @version=5
strategy("SMA Cross Strategy", overlay=true)

// 定義參數
fastLength = 14
slowLength = 28

// 計算指標
fastSMA = ta.sma(close, fastLength)
slowSMA = ta.sma(close, slowLength)

// 繪圖 (模擬)
plot(fastSMA, color=color.blue)
plot(slowSMA, color=color.orange)

// 交易邏輯
longCondition = ta.crossover(fastSMA, slowSMA)
if (longCondition)
    strategy.entry("Long", strategy.long)

shortCondition = ta.crossunder(fastSMA, slowSMA)
if (shortCondition)
    strategy.entry("Short", strategy.short)
`);

            // 初始化數據
            useEffect(() => {
                const data = generateData(activeSymbol, 500);
                setMarketData(data);
                addLog(`載入 ${activeSymbol} 歷史數據: ${data.length} 筆 K 線`);
            }, [activeSymbol]);

            const addLog = (msg) => {
                const time = new Date().toLocaleTimeString();
                setLogs(prev => [`[${time}] ${msg}`, ...prev].slice(0, 50));
            };

            // 初始化圖表
            useEffect(() => {
                if (!chartContainerRef.current) return;

                const chart = createChart(chartContainerRef.current, {
                    layout: { background: { type: 'solid', color: '#0f172a' }, textColor: '#94a3b8' },
                    grid: { vertLines: { color: '#1e293b' }, horzLines: { color: '#1e293b' } },
                    width: chartContainerRef.current.clientWidth,
                    height: chartContainerRef.current.clientHeight,
                    timeScale: { borderColor: '#334155' },
                    rightPriceScale: { borderColor: '#334155' },
                });

                const series = chart.addCandlestickSeries({
                    upColor: '#22c55e', downColor: '#ef4444', borderVisible: false,
                    wickUpColor: '#22c55e', wickDownColor: '#ef4444',
                });

                chartInstance.current = chart;
                candlestickSeries.current = series;

                const handleResize = () => {
                    chart.applyOptions({ width: chartContainerRef.current.clientWidth });
                };
                window.addEventListener('resize', handleResize);

                return () => {
                    window.removeEventListener('resize', handleResize);
                    chart.remove();
                };
            }, []);

            // 數據更新時刷新圖表
            useEffect(() => {
                if (candlestickSeries.current && marketData.length > 0) {
                    candlestickSeries.current.setData(marketData);
                    chartInstance.current.timeScale().fitContent();
                }
            }, [marketData]);

            // 執行策略 (編譯 + 回測)
            const runStrategy = () => {
                if (!marketData.length) return;
                addLog("開始增量編譯策略...");
                const startTime = performance.now();

                try {
                    // 1. 轉譯 Pine -> JS
                    const transpiler = new PineTranspiler(pineCode);
                    const jsFuncBody = transpiler.transpile();
                    
                    // 2. 創建執行環境
                    // 注意：這是不安全的 eval 替代方案，僅用於原型演示
                    const strategyFn = new Function('data', 'ta', jsFuncBody);
                    
                    // 3. 執行策略回測
                    const executionResult = strategyFn(marketData); // 這裡 ta 在內部已定義，這裡為了簡化演示，其實是在內部閉包
                    
                    // *Hack*: 上面的 new Function 比較難傳遞 ta 對象，我們在 transpile 內部直接定義了簡易 ta。
                    // 為了演示，我們重新構建：
                    // 在真實環境會用 Web Worker 處理這裡
                    
                    const endTime = performance.now();
                    addLog(`編譯完成 (${(endTime - startTime).toFixed(1)}ms). 開始計算指標...`);

                    // 4. 更新圖表指標 (Overlay)
                    // 清除舊指標
                    Object.values(indicatorSeries.current).forEach(s => chartInstance.current.removeSeries(s));
                    indicatorSeries.current = {};

                    const colors = ['#3b82f6', '#f59e0b', '#a855f7'];
                    let colorIdx = 0;

                    Object.entries(executionResult.indicators).forEach(([name, dataArray]) => {
                        const lineData = marketData.map((d, i) => ({ time: d.time, value: dataArray[i] })).filter(d => !isNaN(d.value));
                        
                        const lineSeries = chartInstance.current.addLineSeries({
                            color: colors[colorIdx++ % colors.length],
                            lineWidth: 2,
                            title: name,
                        });
                        lineSeries.setData(lineData);
                        indicatorSeries.current[name] = lineSeries;
                    });

                    // 5. 更新買賣標記
                    const markersData = executionResult.signals.map(sig => ({
                        time: sig.time,
                        position: sig.type === 'buy' ? 'belowBar' : 'aboveBar',
                        color: sig.type === 'buy' ? '#22c55e' : '#ef4444',
                        shape: sig.type === 'buy' ? 'arrowUp' : 'arrowDown',
                        text: sig.type === 'buy' ? 'BUY' : 'SELL',
                    }));
                    candlestickSeries.current.setMarkers(markersData);

                    // 6. 計算回測數據
                    const stats = calculateMetrics(executionResult.signals);
                    setBacktestStats(stats);
                    addLog(`回測完成. 總交易: ${stats.tradeCount}, 淨利: ${stats.netProfit}`);

                } catch (err) {
                    console.error(err);
                    addLog(`編譯錯誤: ${err.message}`);
                }
            };

            // Lucide icons ref setup
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [logs, backtestStats]); 

            return (
                <div className="flex flex-col h-screen overflow-hidden">
                    <Header />
                    
                    <div className="flex flex-1 overflow-hidden">
                        {/* 左側邊欄：設置與數據源 */}
                        <div className="w-16 bg-slate-900 border-r border-slate-700 flex flex-col items-center py-4 gap-6 z-10">
                            <div className="p-2 bg-slate-800 rounded-lg cursor-pointer hover:bg-slate-700 text-emerald-400">
                                <i data-lucide="bar-chart-2"></i>
                            </div>
                            <div className="p-2 rounded-lg cursor-pointer hover:bg-slate-800 text-slate-400">
                                <i data-lucide="code"></i>
                            </div>
                            <div className="p-2 rounded-lg cursor-pointer hover:bg-slate-800 text-slate-400">
                                <i data-lucide="database"></i>
                            </div>
                            <div className="p-2 rounded-lg cursor-pointer hover:bg-slate-800 text-slate-400">
                                <i data-lucide="settings"></i>
                            </div>
                        </div>

                        {/* 主工作區 */}
                        <div className="flex-1 flex flex-col min-w-0 bg-slate-950">
                            
                            {/* 上方工具列 */}
                            <div className="h-12 border-b border-slate-800 flex items-center px-4 justify-between bg-slate-900">
                                <div className="flex items-center gap-4">
                                    <div className="flex bg-slate-800 rounded p-1">
                                        {['AAPL', 'TSLA', 'NVDA', 'SPY'].map(sym => (
                                            <button 
                                                key={sym}
                                                onClick={() => setActiveSymbol(sym)}
                                                className={`px-3 py-1 text-xs font-bold rounded ${activeSymbol === sym ? 'bg-slate-600 text-white' : 'text-slate-400 hover:text-white'}`}
                                            >
                                                {sym}
                                            </button>
                                        ))}
                                    </div>
                                    <div className="h-4 w-[1px] bg-slate-700"></div>
                                    <span className="text-sm text-slate-400">Timeframe: <span className="text-white font-bold">1D</span></span>
                                </div>
                                <button 
                                    onClick={runStrategy}
                                    className="flex items-center gap-2 bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-1.5 rounded text-sm font-bold transition-all shadow-lg shadow-emerald-900/20"
                                >
                                    <i data-lucide="play" className="w-4 h-4"></i>
                                    編譯並回測
                                </button>
                            </div>

                            {/* 內容網格 */}
                            <div className="flex-1 grid grid-cols-12 grid-rows-6 gap-1 p-1">
                                
                                {/* 1. 圖表區域 (佔大頭) */}
                                <div className="col-span-9 row-span-4 bg-slate-900 border border-slate-800 rounded relative group">
                                    <div className="absolute top-2 left-2 z-10 text-xs text-slate-500 font-mono opacity-0 group-hover:opacity-100 transition-opacity">Chart Engine v2.1</div>
                                    <div ref={chartContainerRef} className="w-full h-full"></div>
                                </div>

                                {/* 2. 監控面板 (右側) */}
                                <div className="col-span-3 row-span-4 flex flex-col gap-1">
                                    <div className="bg-slate-900 border border-slate-800 rounded p-4 flex-1 overflow-y-auto">
                                        <h3 className="text-sm font-bold text-slate-300 mb-3 flex items-center gap-2">
                                            <i data-lucide="activity" className="w-4 h-4"></i> 回測績效
                                        </h3>
                                        {backtestStats ? (
                                            <div className="grid grid-cols-1 gap-3">
                                                <StatCard label="Net Profit" value={`$${backtestStats.netProfit}`} isPositive={parseFloat(backtestStats.netProfit) > 0} />
                                                <div className="grid grid-cols-2 gap-2">
                                                    <StatCard label="Sharpe Ratio" value={backtestStats.sharpe} isPositive={parseFloat(backtestStats.sharpe) > 1} />
                                                    <StatCard label="Max Drawdown" value={backtestStats.maxDD} isPositive={false} />
                                                </div>
                                                <StatCard label="Total Trades" value={backtestStats.tradeCount} />
                                            </div>
                                        ) : (
                                            <div className="text-center text-slate-600 py-10 text-sm">
                                                等待策略執行...
                                            </div>
                                        )}
                                    </div>
                                    
                                    {/* 系統日誌 */}
                                    <div className="bg-slate-900 border border-slate-800 rounded p-3 h-1/3 flex flex-col">
                                        <h3 className="text-xs font-bold text-slate-500 mb-2 uppercase">System Logs</h3>
                                        <div className="flex-1 overflow-y-auto font-mono text-xs text-slate-400 space-y-1 custom-scrollbar">
                                            {logs.map((log, i) => (
                                                <div key={i} className="truncate border-l-2 border-slate-700 pl-2 hover:bg-slate-800">{log}</div>
                                            ))}
                                        </div>
                                    </div>
                                </div>

                                {/* 3. Pine Script 編輯器 (底部) */}
                                <div className="col-span-12 row-span-2 bg-slate-900 border border-slate-800 rounded flex flex-col">
                                    <div className="h-8 bg-slate-850 border-b border-slate-800 flex items-center px-3 justify-between">
                                        <span className="text-xs font-bold text-slate-300 flex items-center gap-2">
                                            <i data-lucide="file-code" className="w-3 h-3 text-blue-400"></i>
                                            strategy.pine
                                        </span>
                                        <span className="text-xs text-slate-600">Pine Script v5 (Simulated)</span>
                                    </div>
                                    <textarea 
                                        className="flex-1 w-full bg-slate-900 text-slate-300 p-4 font-mono text-sm resize-none focus:outline-none editor-area"
                                        value={pineCode}
                                        onChange={(e) => setPineCode(e.target.value)}
                                        spellCheck="false"
                                    ></textarea>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
